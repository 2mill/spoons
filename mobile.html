<html>
	<head>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
		<link rel="stylesheet" href="http://131.118.95.193/thesis/style.css">
		<link href='http://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	</head>
	<body>
		<div class="container state m0">	
			<div class="row col-centered">
				<h1 class="center-text">Spoons</h1>
				<h4 class="center-text">Your game session has been disconnected. Please refresh the page and join another game session.</h4>
			</div>
			<div>
				<a href="http://131.118.95.193:3000"><button id="m0_refresh_page" type="button" class="btn btn-primary fill-width make-tall-fifty" aria-label="Left Align">
					Refresh
				  <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
				</button></a>
			</div>
		</div>

		<div class="container state m1">	
			<div class="row col-centered">
				<h1 class="center-text">Spoons</h1>
				<h5 class="center-text">A game developed by Steven Moon</h5>
				<h5 class="center-text">Frostburg State University</h5>
			</div>
			<div class="row col-centered">
				<!--<div class="col-xs-12 col-md-3"></div>-->
				
				<div class="form-group has-success has-feedback">
			        <label class="control-label" for="inputSuccess4">Room to join:</label>
			        <input type="text" class="form-control" id="m1_room_name" aria-describedby="inputSuccess4Status">
			        <!--<span class="glyphicon glyphicon-ok form-control-feedback" aria-hidden="true"></span>
			        <span id="inputSuccess4Status" class="sr-only">(success)</span>-->
			    </div>
				<div class="form-group has-success has-feedback">
			        <label class="control-label" for="inputSuccess5">User Name:</label>
			        <input type="text" class="form-control" id="m1_user_name" aria-describedby="inputSuccess5Status">
			        <!--<span class="glyphicon glyphicon-ok form-control-feedback" aria-hidden="true"></span>
			        <span id="inputSuccess5Status" class="sr-only">(success)</span>-->
			    </div>

				<button id="m1_join_room" type="button" class="btn btn-primary fill-width make-tall-fifty" aria-label="Left Align">
					Join Room
				  <span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span>
				</button>
				
				<div class="col-xs-12 col-md-3"></div>
			</div>
			<div class='row col-centered'>
				<p id="m1_feedback" style='color:red'></p>
			</div>
			<p></p>
			<div class="row col-centered">
				<div class="col-xs-12 col-md-3">
					<a id="adv_settings" href="#">Advanced Settings...</a>
					<button id="m1_use_as_desktop" type="button" class="btn btn-warning fill-width make-tall-fifty" aria-label="Left Align">
						Use as Desktop
					  <span class="glyphicon glyphicon-th-large" aria-hidden="true"></span>
					</button>
				</div>
			</div>
		</div> <!-- End State m1 -->

		<div class="container state m2">
			<div class="row col-centered">
				<img src="http://131.118.95.193/thesis/loading.gif" class="img-responsive" alt="Responsive image">
			</div>
			<div class="row col-centered">
				<h3 class="center-text">Waiting for additional players...</h3>
			</div>
			<div class="row col-centered">
				<button id="m2_instructions" type="button" class="btn btn-default fill-width make-tall-fifty" aria-label="Left Align">
						View Instructions
				  <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
				</button>
			</div>
		</div><!-- End State m2 -->

		<div class="container state m3">
			<p></p>
			<div class="row other-centered">
				<canvas id="piechart" class="centerme" width="250" height="250">
				</canvas>
			</div>
			<div class="row col-centered">
				<h3 id="start_feedback" class="center-text">Press Play to start game...</h3>
			</div>
			<div class="row col-centered">
				<div class="col-xs-12 col-md-3"></div>
				<div class="col-xs-12 col-md-6">
					<button id="m3_play_game" type="button" class="btn btn-success fill-width make-tall-fifty" aria-label="Left Align">
							Play Game
					  <span class="glyphicon glyphicon-play" aria-hidden="true"></span>
					</button>
				</div>
				<div class="col-xs-12 col-md-3"></div>
			</div>
			<div class="row col-centered">
				<div class="col-xs-12 col-md-3"></div>
				<div class="col-xs-12 col-md-6">
					<button id="m2_instructions" type="button" class="btn btn-default fill-width make-tall-fifty" aria-label="Left Align">
							View Instructions
					  <span class="glyphicon glyphicon-list" aria-hidden="true"></span>
					</button>
				</div>
				<div class="col-xs-12 col-md-3"></div>
			</div>

			<div class="modal fade" id="m3_prompt" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			  <div class="modal-dialog">
			    <div class="modal-content">
			      <div class="modal-header">
			        <!--<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>-->
			        <h4 class="modal-title" id="e_myModalLabel">Game Over!</h4>
			      </div>
			      <div id="m3_modalBody"class="modal-body">
			      	<p><b id="m3_loserName">User Joe</b> failed to grab a spoon!</p>
			      	<p></p>
			      	<p>Would You like to play again?</p>
			      </div>
			      <div id="m3_modalFooter"class="modal-footer">
			      	<button id='m3_playAgain'type='button' class='btn btn-success customButton' data-dismiss="modal">Yes!</button>
			        <button id='m3_quitGame'type="button" class="btn btn-danger customButton">No</button>
			      </div>
			    </div>
			  </div>
			</div>	
		</div><!-- End State m3 -->

		<div class="state m4">
			<div class="m4top">
				<div class="m4tq"><div id="card1" class="cardslot"></div></div>
				<div class="m4tq"><div id="card2" class="cardslot"></div></div>
				<div class="m4tq"><div id="card3" class="cardslot"></div></div>
				<div class="m4tq"><div id="card4" class="cardslot"></div></div>
			</div>
			<div id="center" class="m4mid"><!-- comments to fix inline block
			--><div class="m4midL"></div><!-- comments to fix inline block
			--><div class="m4midM"><div id="m4_cardholder" data-card=''></div></div><!-- comments to fix inline block
			--><div class="m4midR"></div><!-- comments to fix inline block
			--><div class="m4midRR"><div id="m4_cardpile"></div></div><!-- comments to fix inline block
			--></div>
			<div class="m4bot">
				<button type="button" id="m4_grabbutton" class="btn btn-success"><b>Grab Spoon!</b></button>
			</div>
		</div><!-- End State m4 -->

		<div class="state m5">
			<div class="m4top"></div>
			<div class="m4mid centerme">
				<img class="spoon" src="http://131.118.95.193/thesis/spoon.png" height="100%">
			</div>
			<div class="m4bot"></div>
		</div>
		
		<script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="socket.io/socket.io.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
		<script src="http://131.118.95.193/thesis/piechart.js"></script>
		<script src="https://hammerjs.github.io/dist/hammer.js"></script>
		<script>
		var socket = io('http://131.118.95.193:3000');
		var currRoom='';
		var userName='';
		var tog=true;

		function validate1(){
			if($('#m1_room_name').val()==''||$('#m1_room_name').val()==null){
				$('#m1_feedback').html('Please provide a room name');
				return false;
			}
			if($('#m1_user_name').val()==''||$('#m1_user_name').val()==null){
				$('#m1_feedback').html('Please provide a user name');
				return false;
			}
			return true;
		}

		function hideGrabButton(){
			$('#m4_grabbutton').hide();
			setTimeout(function(){
				$('#m4_grabbutton').show();
			},3000);
		}

		function createPieChart(ia,lab) {
			var temp=[];
			var sum=0;
			var sum2=0;
			var i=0;
			for(i=0;i<ia.length;i++){
				sum+=ia[i];
			}
			for(i=0;i<ia.length;i++){
				if(i==ia.length-1){
					temp[temp.length]=(360-sum2);
				}
				else{
					temp[temp.length]=(Math.floor(360*(ia[i]/sum)));
					sum2+=temp[temp.length-1];
				}
			}
			var pieChart = new PieChart( "piechart", 
				{
					includeLabels: true, 
					data: temp,
					labels: lab,
					colors: [
		            	["#D50000", "#D50000"],
		            	["#6CFF01", "#6CFF01"]
					]
				}
			);
			pieChart.draw();
		}
		</script>


		<script>
		var c1e = document.getElementById('card1');
		var card1 = new Hammer(c1e);
		var c2e = document.getElementById('card2');
		var card2 = new Hammer(c2e);
		var c3e = document.getElementById('card3');
		var card3 = new Hammer(c3e);
		var c4e = document.getElementById('card4');
		var card4 = new Hammer(c4e);
		var ce = document.getElementById('center');
		var center = new Hammer(ce);

		$(document).ready(function(){
			goToState(1);
			$("#m1_use_as_desktop").hide();
			$('#m4_cardpile').hide();

			$(document).bind('touchmove', function(e) {
				e.preventDefault();
			});
			$("#adv_settings").click(function(){
				tog=!tog;
				if(tog){
					$("#m1_use_as_desktop").hide();
					$("#adv_settings").html("Advanced Settings...");
				}
				else{
				$("#m1_use_as_desktop").show();
					$("#adv_settings").html("Hide Settings...");
				}
			});
			$("#m1_use_as_desktop").click(function(){
				window.location.replace("http://131.118.95.193:3000/desktop");
			});
			$("#m1_join_room").click(function(){
				if(validate1()){
					socket.emit('player login',{name:$('#m1_user_name').val(),rname:$('#m1_room_name').val()});
				}
			});

			$("#m3_play_game").click(function(){
				socket.emit('player clicked ready',{un:userName,rm:currRoom});
			});

			$("#m4_grabbutton").click(function(){
				var temp={
					rm:currRoom,
					un:userName
				}
				socket.emit('grab spoon', temp);
			});

			$("#m3_quitGame").click(function(){
				var temp={
					rm:currRoom,
					un:userName
				}
				socket.emit('custom disconnect',temp);
				socket.disconnect();
				goToState(0);
			});

			/*
			center.on("panleft panright panup pandown tap press",function(ev){
				ce.textContent = ev.type +" gesture detected.";
			});
			*/
			center.on("swipeleft",function(){
				var temp={
					rm:currRoom,
					un:userName,
					card:$('#m4_cardholder').data('card')
				}
				socket.emit('pass left', temp);
				$('#m4_cardpile').hide();
			});

			card1.on("panstart",function(ev){
				var temp={
					rm:currRoom,
					un:userName,
					slot:0
				}
				socket.emit('discard',temp);
			});
			card2.on("panstart",function(ev){
				var temp={
					rm:currRoom,
					un:userName,
					slot:1
				}
				socket.emit('discard',temp);
			});
			card3.on("panstart",function(ev){
				var temp={
					rm:currRoom,
					un:userName,
					slot:2
				}
				socket.emit('discard',temp);
			});
			card4.on("panstart",function(ev){
				var temp={
					rm:currRoom,
					un:userName,
					slot:3
				}
				socket.emit('discard',temp);
			});
		});

		function goToState(st){
			$('.state').hide();
			$('.m'+st).show();
			if(st==4){
				card1.get('pan').set({ direction: Hammer.DIRECTION_ALL });
				card2.get('pan').set({ direction: Hammer.DIRECTION_ALL });
				card3.get('pan').set({ direction: Hammer.DIRECTION_ALL });
				card4.get('pan').set({ direction: Hammer.DIRECTION_ALL });
				center.get('pan').set({ direction: Hammer.DIRECTION_ALL });
			}
		}

		//~~~~~~~~~~~~~~~~~~~~Event Driven Networking~~~~~~~~~~~~~~~~

		socket.on('test1', function (data) {
			console.log("Aw yeah in room:"+data);
			//socket.emit('my other event', { my: 'data' });
		});

		socket.on('room doesnt exist',function(){
			$('#m1_feedback').html('Room doesn\'t exist');
		});

		socket.on('room at capacity',function(){
			$('#m1_feedback').html('Room is at capacity');
		});

		socket.on('game already started',function(){
			$('#m1_feedback').html('The game has already started in this room!');
		});

		socket.on('username in use',function(){
			$('#m1_feedback').html('Username already in use. Please choose another.');
		});

		socket.on('first login success',function(roomInfo){
			goToState(2);
			var ia=[1];
			var lab=["No Players Ready", "Ready"];
			createPieChart(ia,lab);
			//currRoom=roomInfo.name;
		});

		socket.on('subsequent login success',function(roomInfo){
			goToState(3);
			var readyToPlay=0;
			for(var i=0;i<roomInfo.players.length;++i){
				if(roomInfo.players[i].readyToPlay){
					readyToPlay++;
				}
			}
			var ia=[roomInfo.players.length-readyToPlay,readyToPlay];
			var lab=["Not ready", "Ready"];
			createPieChart(ia,lab);
			//currRoom=roomInfo.name;
		});

		socket.on('register user',function(info){
			userName=info.name;
			currRoom=info.rname;
			//alert('user: '+userName+' | room: '+currRoom);
		});

		socket.on('indiv player ready',function(){
			$("#start_feedback").html("Waiting for other players to start...");
			$("#m3_play_game").hide();
		});

		socket.on('player ready',function(roomInfo){
			var readyToPlay=0;
			for(var i=0;i<roomInfo.players.length;++i){
				if(roomInfo.players[i].readyToPlay){
					readyToPlay++;
				}
			}
			var ia=[roomInfo.players.length-readyToPlay,readyToPlay];
			var lab=["Not ready", "Ready"];
			createPieChart(ia,lab);
		});

		socket.on('all players ready',function(roomInfo){
			goToState(4);
			var temp={
				un:userName,
				rm:currRoom
			}
			socket.emit('get hand',temp);
		});

		socket.on('all viewers gone', function(){
			goToState(0);
			socket.disconnect();
		});

		socket.on('update hand', function(hand){
			$('#card1').html("<b>"+hand[0]+"</b>");
			$('#card2').html("<b>"+hand[1]+"</b>");
			$('#card3').html("<b>"+hand[2]+"</b>");
			$('#card4').html("<b>"+hand[3]+"</b>");
		});

		socket.on('display pile',function(){
			$('#m4_cardpile').show();
		});

		socket.on('set current card',function(card){
			$('#m4_cardholder').html("<h1>"+card+"</h1>");
			$('#m4_cardholder').data("card",card);
		});

		socket.on('display spoon',function(){
			goToState(5);
		});

		socket.on('invalid grab', function(){
			hideGrabButton();
		});

		socket.on('game over',function(un){
			$("#m3_play_game").show();
			$("#m3_prompt").modal('show');
			$('#m3_loserName').html(un);
		});

		</script>

	</body>
</html>